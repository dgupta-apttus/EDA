SELECT CURRENT_ROLE();

Select TABLE_CATALOG||'.'||TABLE_SCHEMA||'.'||TABLE_NAME, MAX(ORDINAL_POSITION)
 FROM APTTUS_DW.INFORMATION_SCHEMA.COLUMNS
 WHERE TABLE_NAME LIKE 'OPPORTUNITY_A1_SNAP%'
 GROUP by TABLE_CATALOG, TABLE_SCHEMA, TABLE_NAME
 order by 1
; 

with get_last as(
        Select MAX(ORDINAL_POSITION) as LAST_COL
         FROM APTTUS_DW.INFORMATION_SCHEMA.COLUMNS
         WHERE TABLE_NAME = 'OPPORTUNITY_A1_SNAP_1'
)
Select TABLE_CATALOG||'.'||TABLE_SCHEMA||'.'||TABLE_NAME, ORDINAL_POSITION, COLUMN_NAME
 FROM APTTUS_DW.INFORMATION_SCHEMA.COLUMNS
 WHERE TABLE_NAME LIKE 'OPPORTUNITY_A1_SNAP%'
   AND ORDINAL_POSITION > ((SELECT LAST_COL from get_last)-1)
   AND COLUMN_NAME <> 'SNAP_LOAD_AT'
 ORDER BY 1, 2  
;  

Select TABLE_SCHEMA, TABLE_NAME, COLUMN_NAME, ORDINAL_POSITION
FROM APTTUS_DW.INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_NAME LIKE 'OPPORTUNITY_A1_SNAP%'
ORDER BY ORDINAL_POSITION, TABLE_NAME 
;

select count(*) from APTTUS_DW.SNAPSHOTS.OPPORTUNITY_A1_SNAP_1;
select count(*) from APTTUS_DW.SNAPSHOTS.OPPORTUNITY_A1_SNAP_1604725513858_1610186465728;
select count(*) from APTTUS_DW.SNAPSHOTS.OPPORTUNITY_A1_SNAP_1604725513858_1610359276293;

-- CHANGE -- uncommend insert and update table name to previous snap
-- CHANGE -- manage columns near bottom
INSERT INTO APTTUS_DW.SNAPSHOTS.OPPORTUNITY_A1_SNAP_1604725513858_1610186465728 
          (ACCOUNTID, ACTUAL_END_USER_REVENUE__C, ACTUAL_STANDARD_TRAINING_REVENUE__C, AGE_OF_DEAL__C, AGE_OF_THE_DEAL_DAYS__C, AIC_TECHNICAL_CONTACT__C, AMOUNT, AMS_AVG_ACV__C, AMS_RAMPED_ACV__C, AMS_TOTAL_DEAL_VALUE__C, ANY_SPECIAL_CONDITION__C, APPROVED_CONCESSION_AMOUNT__C, APTTUS_EXEC_SPONSOR__C, APTTUS_SERVICES_MAN_HRS__C, APTTUS_SERVICE_BOOKINGS__C, APTTUS_SE__C, APTTUS_TRAINER__C, ARE_EXPENSES_BILLABLE__C, AUTO_RENEWAL__C, BDR_ASSIGNED_TO_OPPTY__C, BDR_MANAGER_APPROVED__C, BIG_DEAL_TRACKER__C, BILL_TO__C
        , BUDGET_CONFIRMED__C, BUSINESS_NEEDS_AND_PAIN_POINTS__C, BYPASSVALIDATIONFORPROCESSBUILDER__C, CAMPAIGNID, CAMPAIGN_LIST__C, CHAMPION_NAME__C, CHAMPION_NOTES__C, CLOSEDATE, CLOSING_PLAN_PAPER_PROCESS__C, COACH_NAME_S__C, COACH_NOTES__C, COMMISSION_ACV__C, COMMISSION_ELIGIBLE__C, COMMISSION_NOTES__C, COMPELLING_EVENT__C, COMPETITION_NOTES__C, CONTACT__C, CONTINGENCY_AVG_ACV__C, CONTINGENCY_END_DATE__C, CONTINGENCY_FIRST_YEAR_ACV__C, CONTINGENCY_NOTES__C, CONTINGENCY_RAMPED_ACV__C, CONTINGENCY_TYPE__C
        , CONTINGENCY__C, CREATEDBYID, CREATEDDATE, CREATED_BY_BDR_GROUP__C, CREATED_REVIVED_DATE__C, CURRENCYISOCODE, DATE_OF_PROVISIONING__C, DATE_OF_SUBMISSION__C, DEAL_DESK_REVIEWER__C, DEAL_DESK_STATUS__C, DEAL_TYPE__C, DECISION_CRITERIA_NOTES__C, DECISION_PROCESS_NOTES__C, DECISION_PROCESS__C, DESCRIPTION, DE_BOOK__C, DISCOVERY_COMPLETED__C, DO_WE_FULFILL_CUST_DECISION_CRITERIA__C, DO_WE_HAVE_A_CHAMPION_SUPPORTING_DEAL__C, DO_WE_HAVE_SOMEONE_FILTERING_INFORMATION__C, DSCORGPKG__ATTRIBUTED_TO_DISCOVERORG__C
        , DSCORGPKG__CONVERTED_FROM_DISCOVERORG_DATA__C, DYNAMICS_GUID__C, ECONOMIC_BUYER_NAME_S__C, ECONOMIC_BUYER_NOTES__C, EMPTORIS_SWAP__C, END_USER_REVENUE__C, ESTIMATED_LAUNCH_POINTS__C, ESTIMATED_OF_USERS__C, ESTIMATED_SERVICES_REVENUE__C, EST_HOURS_FROM_NEW_ESTIMATOR__C, EVALUATION_PROCESS__C, EVALUATION_TIME_FRAME__C, EXPANSION__C, EXPECTEDREVENUE, EXPECTED_GO_LIVE_DATE__C, EXPECTED_START_DATE__C, EXPECTED_TRAINING_DELIVERY__C, FINANCE_REVIEW_STATUS__C, FIRST_YEAR_ACV__C, FISCAL, FISCALQUARTER, FISCALYEAR, FOCUSED_VERTICAL__C, FORECASTCATEGORY, FORECASTCATEGORYNAME, FORECAST_CATEGORY__C
        , FX_RATE__C, GTM_PARTNER_NOTES__C, HASOPENACTIVITY, HASOPPORTUNITYLINEITEM, HASOVERDUETASK, HAVE_WE_IDENTIFIED_THE_COMPETITION__C, HIGHEST_ACHIEVED_STAGE_VALUE__C, HIGHEST_ACHIEVED_STAGE__C, HIGHEST_STAGE_VALUE__C, ID, IDENTIFY_PAIN_NOTES__C, IDENTIFY_PAIN__C, IMPLEMENTATION_PRIME__C, IMPLEMENTATION_TIMEFRAME__C, INBOUND_OUTBOUND_OPPORTUNITY__C, IN_QUARTER_BILLING__C, ISCLOSED, ISDELETED, ISPRIVATE, ISR__C, ISSPLIT, ISWON, IS_CLOSED_LOST_EMAIL_SENT__C, IS_CLOSED_WON_EMAIL_SENT__C, IS_THERE_A_RFP__C, IS_THE_BUSINESS_CASE_QUANTIFIED__C, KEY_NOTES__C, LASTACTIVITYDATE, LASTMODIFIEDBYID, LASTMODIFIEDDATE, LASTREFERENCEDDATE, LASTVIEWEDDATE, LEADSOURCE, LEAD_SOURCE_GLOBAL__C, LEGACY_CREATEDDATE__C, LEGACY_OWNER_NAME__C, LEGAL_REVIEW_STATUS__C, LID__IS_INFLUENCED__C, LIST_PRICE__C, LOCKED__C, LOSS_REASON__C, LOSS_SUB_CATEGORY__C
        , MANAGED_SERVICES_BOOKINGS__C, MANAGEMENT_APPROVAL_STATUS__C, MANAGER_NOTES__C, MANAGER__C, MEDDPICCC_SCORE__C, METRIC_NOTES__C, MKTO_SI__MARKETOANALYZER__C, MONTHS_TO_FULLY_RAMPED__C, NAME, NEW_ESTIMATOR__C, NEXTSTEP, NEXT_STEP_LAST_EDITED__C, NON_STANDARD_DEAL_NOTES__C, NON_STANDARD_DEAL__C, OPERATIONS_REVIEW_STATUS__C, OPPORTUNITY_ACCEPTED_DATE__C, OPPORTUNITY_ACCEPTED__C, OPPORTUNITY_SOURCE_OVERRIDE__C, OPPORTUNITY_SOURCE__C, ORDER_FORM_TCV__C, ORDER_SIGNATURE_DATE__C, OWNERID, PACKAGE_TYPE__C, PAGE_2_ROYALTY__C, PAPER_PROCESS_NOTES__C, PARTNER_SALES_REP__C, PARTNER_SOURCE__C, PLATFORM__C, PRICEBOOK2ID, PRIMARY_COMPETITOR__C, PRIMARY_QUOTE_ID__C, PRIOR_PRIMARY_QUOTE_ID__C, PROBABILITY, PRODUCTION_ORG_ID__C, PRODUCTS_OF_INTEREST__C, PROFESSIONAL_JUDGEMENT__C, PROJECTED_SI_PARTNER__C, PROJECT__C, PSACURRENT_SERVICE_ESTIMATE__C
        , PSE__ISPARENTOPPORTUNITYSERVICES__C, PSE__IS_CHANGE_REQUEST__C, PSE__IS_SERVICES_OPPORTUNITY__C, PSE__PARENT_OPPORTUNITY__C, PSE__PRACTICE__C, PSE__PRIMARY_PROJECT__C, PSE__REGION__C, PSE__SERVICES_ATTACHED_FROM_PRODUCTS__C, PSE__SERVICES_ATTACHED_PERCENT_FROM_PRODUCTS__C, PS_DELIVERY_OWNER__C, PS_GLOBAL_REGION__C, PS_NA_REGION__C, PS_NOTES__C, PURCHASE_ORDER_NUMBER__C, PURCHASE_ORDER__C, QUOTA_ATTAINMENT__C, RAMPED_ACV__C, RECORDTYPEID, REGION__C, RENEWAL_ACV__C, RENEWAL_DIRECTOR_NOTES__C, RENEWAL_DUE__C, RENEWAL_UPLIFT__C, RENEWAL__C, REVIVED_DATE__C, ROI_ANALYSIS_COMPLETED__C, SALES_OPS_APPROVED__C, SALES_OPS_BOOKING_NOTES__C, SALES_PLAYS__C, SCOPE_OF_PROJECT__C, SECONDARY_COMPETITORS__C, SEGMENTATION__C, SERVICES_BILLING_TYPE__C, SERVICES_SELLING_RATE__C, SERVICE_OPPORTUNITY_TYPES__C, SHIP_TO__C, SI_PARTNER_LOOKUP__C
        , SI_PARTNER_NOTES__C, SI_PARTNER__C, STAGE1_ENTRY_AVG_ACV__C, STAGENAME, STAGETONUMBER__C, STAGE_0_DATE_OF_ENTRY__C, STAGE_0_DATE_OF_EXIT__C, STAGE_0_DURATION__C, STAGE_1_DATE_OF_ENTRY__C, STAGE_1_DATE_OF_EXIT__C, STAGE_1_DURATION__C, STAGE_1_EXIT_AVG_ACV__C, STAGE_2_DATE_OF_ENTRY__C, STAGE_2_DATE_OF_EXIT__C, STAGE_2_DURATION__C, STAGE_3_DATE_OF_ENTRY__C, STAGE_3_DATE_OF_EXIT__C, STAGE_3_DURATION__C, STAGE_4_DATE_OF_ENTRY__C, STAGE_4_DATE_OF_EXIT__C, STAGE_4_DURATION__C, STAGE_5_DATE_OF_ENTRY__C, STAGE_5_DATE_OF_EXIT__C, STAGE_5_DURATION__C, STAGE_6_DATE_OF_ENTRY__C, STAGE_6_DATE_OF_EXIT__C, STAGE_6_DURATION__C, STAGE_7_DATE_OF_ENTRY__C, STAGE_7_DATE_OF_EXIT__C, STAGE_7_DURATION__C, STAGE_8_DATE_OF_ENTRY__C, STAGE_9_DATE_OF_ENTRY__C, STANDARD_TRAINING_REVENUE__C, SUBSCRIPTION_OPPORTUNITY__C, SUBSCRIPTION_START_DATE__C
        , SUB_REGION__C, SUB_TYPE__C, SUPPORT_AVG_ACV__C, SUPPORT_FIRST_YEAR_ACV__C, SUPPORT_RAMPED_ACV__C, SUPPORT_TOTAL_DEAL_VALUE__C, SYNCEDQUOTEID, SYSTEMMODSTAMP, TCV_NOT_COMMITTED__C, TERM_MONTHS__C, TOTAL_DEAL_VALUE__C, TOTAL_TRAINING_REVENUE__C, TSPC__CPDEALCOUNT__C, TYPE, VALID_UNTIL_DATE__C, VALUE_PROP_TO_ECONOMIC_BUYER__C, WEIGHTED_ACV__C, WHY_BUY_NOW__C, WIN_LOSS_DETAIL_NOTES_MGR__C, WIN_LOSS_DETAIL_NOTES__C, WIN_LOSS_FY_QUARTER__C, WIN_REASON__C, WON_LOST_DATE__C, X18_DIGIT_OLD_SFDC_ID__C, X18_DIGIT_SFDC_ID__C, _SDC_BATCHED_AT, _SDC_EXTRACTED_AT, _SDC_RECEIVED_AT, _SDC_SEQUENCE, _SDC_TABLE_VERSION, SEGMENTATION1__C, DE_BOOKED_OPPORTUNITY__C, CAMPAIGN_LIST_DEL__C, BUDGETARY_ESTIMATE_STATUS__C, ACCOUNT_INTEGRATION_STATUS__C, UPDATE__C, SALES_ORDER_INTERNAL_ID__C, SALES_ORDER_NUMBER__C, SALES_ORDER_STATUS__C
        , SALES_OPS_VERIFIED__C, REASON_FOR_DOWN_SELL__C, PARTNER__C, TOTAL_RENEWAL_DUE__C, SHIP_TO_NUM__C, BILL_TO_NUM__C, RENEWAL_UPLIFT_PERCENT__C, AVERAGE_ACV__C, APTTUS_APPROVAL__APPROVAL_STATUS__C, TOTALOPPORTUNITYQUANTITY, TSPC__CPDEAL__C, TSPC__CPSTAGEAP_EVENTBEHAVIOR__C, TSPC__CP_TEMPLATENAME__C, TSPC__CPSTAGEAP_ENABLED__C, DEAL_REVIEW_DATE__C, RENEWAL_DUE_FISCAL_QUARTER__C, RENEWAL_DUE_DATE__C, HAS_PWC_AS_PARTNER_SOURCE__C, CONGA_OPPORTUNITY_ID__C, ISEXCLUDEDFROMTERRITORY2FILTER, TERRITORY2ID, FISCAL_WEEK__C, GEO__C, SEGMENT__C, INFLUENCED_PARTNER_MANAGER__C, TOTAL_UPSELL_DOWNSELL__C, PARTNER_SOURCE_MANAGER__C, ANNUAL_RENEWAL__C, RENEWED_AMOUNT__C, TMP_UPDATE_ACCOUNT__C, AT_RISK_ACCOUNT_MANAGER_INVOLVEMENT__C, OPPORTUNITY_HOLD__C, OVERALL_SCORE__C, CSM_FORECAST__C, COVID_IMPACT__C, NPS__C, CSM_SENTIMENT__C
        , X18_DIGIT_ACCOUNT_SFDC_ID__C, RPA_BOT_STATUS__C, RENEWAL_PROBABILITY__C, RPA_BOT_ORDER_FORM_EMAILED__C, NEXT_STEP_FOR_BT_VC__C, NEXT_STEP_FOR_BT_VC_LAST_EDITED__C, OVERALL_HEALTH__C, RVP_UPSIDE__C, RVP_COMMIT__C, RVP_COMMENT__C, TOTAL_RVP_POTENTIAL__C, DESCRIPTION_FOR_BT_VC__C, NPS__C__ST, COVID_IMPACT__C__ST, TMP_FISCAL_WEEK_FORMULA__C, CREATED_FISCAL_YEAR__C, USE_CASE_LINE_OF_BUSINESS__C, USE_CASE__C, NEED__C, WIN_STRATEGY__C, DIFFERENTIATORS__C, CRITICAL_EVENT_DESCRIPTION__C, AGREED_SUCCESS_PATH__C, N_NETWORK_OF_POWER__C, WHY_NOW__C, ORDER_OF_EVENTS__C, O_OBJECTIONS_AND_RISKS__C, USE_CASE_DESCRIPTION__C, GAINED_VALUE__C, OPPORTUNITY_OWNER_PHONE__C, OPPORTUNITY_OWNER_NAME__C, OPPORTUNITY_OWNER_EMAIL__C, DOWNSELL_CHURN_SUB_CATEGORY__C, DOWNSELL_CHURN_CATEGORY__C, ENTRY_ACV__C, INCLUDE_IN_BIG_DEAL_REVIEW__C, EXECUTIVE_COMMENT__C
        , PRICE_INCREASE__C, C1_18_DIGIT_SFDC_ID__C, SUBSCRIPTION_RENEWED__C, SUBSCRIPTION_ATR__C, SUPPORT_RENEWED__C, SUPPORT_ATR__C, EXECUTIVE_JUDGEMENT_LOCK_FLAG__C, EXECUTIVE_FC_LOCK_FLAG__C
        , EXECUTIVE_FORECAST_CATEGORY__C, STAGE_1_DATE_ENTRY__C, APTS_RELATED_PSOD_AGREEMENT__C, CRO_COMMIT__C, WIN_ROOM__C, DEAL__C, NORTH_AMERICA_OWNER__C, SERVICE_SEGMENT__C, EMEA_OWNER__C, DERIVED_PS_GLOBAL_REGION__C
        , DERIVED_PS_NA_REGION__C, SECONDARY_PRODUCT_OF_INTEREST__C, ACCELERATOR_POSITIONED__C, EXPERT_SERVICES_POSITIONED__C, OTHER_COMPETITOR__C, PARTNER_REQUESTED__C, SALES_TAGS__C, IS_AUTOMATED_SERVICE_OPP__C, OWNERSMANAGEREMAIL__C, CREATEDBYMANAGEREMAIL1__C
        -- 2021/01/09
        , OUTREACH_SEQUENCE_ATTRIBUTED__C
          --            
          , SNAP_LOAD_AT) 	
SELECT ACCOUNTID, ACTUAL_END_USER_REVENUE__C, ACTUAL_STANDARD_TRAINING_REVENUE__C, AGE_OF_DEAL__C, AGE_OF_THE_DEAL_DAYS__C, AIC_TECHNICAL_CONTACT__C, AMOUNT, AMS_AVG_ACV__C, AMS_RAMPED_ACV__C, AMS_TOTAL_DEAL_VALUE__C, ANY_SPECIAL_CONDITION__C, APPROVED_CONCESSION_AMOUNT__C, APTTUS_EXEC_SPONSOR__C, APTTUS_SERVICES_MAN_HRS__C, APTTUS_SERVICE_BOOKINGS__C, APTTUS_SE__C, APTTUS_TRAINER__C, ARE_EXPENSES_BILLABLE__C, AUTO_RENEWAL__C, BDR_ASSIGNED_TO_OPPTY__C, BDR_MANAGER_APPROVED__C, BIG_DEAL_TRACKER__C, BILL_TO__C
        , BUDGET_CONFIRMED__C, BUSINESS_NEEDS_AND_PAIN_POINTS__C, BYPASSVALIDATIONFORPROCESSBUILDER__C, CAMPAIGNID, CAMPAIGN_LIST__C, CHAMPION_NAME__C, CHAMPION_NOTES__C, CLOSEDATE, CLOSING_PLAN_PAPER_PROCESS__C, COACH_NAME_S__C, COACH_NOTES__C, COMMISSION_ACV__C, COMMISSION_ELIGIBLE__C, COMMISSION_NOTES__C, COMPELLING_EVENT__C, COMPETITION_NOTES__C, CONTACT__C, CONTINGENCY_AVG_ACV__C, CONTINGENCY_END_DATE__C, CONTINGENCY_FIRST_YEAR_ACV__C, CONTINGENCY_NOTES__C, CONTINGENCY_RAMPED_ACV__C, CONTINGENCY_TYPE__C
        , CONTINGENCY__C, CREATEDBYID, CREATEDDATE, CREATED_BY_BDR_GROUP__C, CREATED_REVIVED_DATE__C, CURRENCYISOCODE, DATE_OF_PROVISIONING__C, DATE_OF_SUBMISSION__C, DEAL_DESK_REVIEWER__C, DEAL_DESK_STATUS__C, DEAL_TYPE__C, DECISION_CRITERIA_NOTES__C, DECISION_PROCESS_NOTES__C, DECISION_PROCESS__C, DESCRIPTION, DE_BOOK__C, DISCOVERY_COMPLETED__C, DO_WE_FULFILL_CUST_DECISION_CRITERIA__C, DO_WE_HAVE_A_CHAMPION_SUPPORTING_DEAL__C, DO_WE_HAVE_SOMEONE_FILTERING_INFORMATION__C, DSCORGPKG__ATTRIBUTED_TO_DISCOVERORG__C
        , DSCORGPKG__CONVERTED_FROM_DISCOVERORG_DATA__C, DYNAMICS_GUID__C, ECONOMIC_BUYER_NAME_S__C, ECONOMIC_BUYER_NOTES__C, EMPTORIS_SWAP__C, END_USER_REVENUE__C, ESTIMATED_LAUNCH_POINTS__C, ESTIMATED_OF_USERS__C, ESTIMATED_SERVICES_REVENUE__C, EST_HOURS_FROM_NEW_ESTIMATOR__C, EVALUATION_PROCESS__C, EVALUATION_TIME_FRAME__C, EXPANSION__C, EXPECTEDREVENUE, EXPECTED_GO_LIVE_DATE__C, EXPECTED_START_DATE__C, EXPECTED_TRAINING_DELIVERY__C, FINANCE_REVIEW_STATUS__C, FIRST_YEAR_ACV__C, FISCAL, FISCALQUARTER, FISCALYEAR, FOCUSED_VERTICAL__C, FORECASTCATEGORY, FORECASTCATEGORYNAME, FORECAST_CATEGORY__C
        , FX_RATE__C, GTM_PARTNER_NOTES__C, HASOPENACTIVITY, HASOPPORTUNITYLINEITEM, HASOVERDUETASK, HAVE_WE_IDENTIFIED_THE_COMPETITION__C, HIGHEST_ACHIEVED_STAGE_VALUE__C, HIGHEST_ACHIEVED_STAGE__C, HIGHEST_STAGE_VALUE__C, ID, IDENTIFY_PAIN_NOTES__C, IDENTIFY_PAIN__C, IMPLEMENTATION_PRIME__C, IMPLEMENTATION_TIMEFRAME__C, INBOUND_OUTBOUND_OPPORTUNITY__C, IN_QUARTER_BILLING__C, ISCLOSED, ISDELETED, ISPRIVATE, ISR__C, ISSPLIT, ISWON, IS_CLOSED_LOST_EMAIL_SENT__C, IS_CLOSED_WON_EMAIL_SENT__C, IS_THERE_A_RFP__C, IS_THE_BUSINESS_CASE_QUANTIFIED__C, KEY_NOTES__C, LASTACTIVITYDATE, LASTMODIFIEDBYID, LASTMODIFIEDDATE, LASTREFERENCEDDATE, LASTVIEWEDDATE, LEADSOURCE, LEAD_SOURCE_GLOBAL__C, LEGACY_CREATEDDATE__C, LEGACY_OWNER_NAME__C, LEGAL_REVIEW_STATUS__C, LID__IS_INFLUENCED__C, LIST_PRICE__C, LOCKED__C, LOSS_REASON__C, LOSS_SUB_CATEGORY__C
        , MANAGED_SERVICES_BOOKINGS__C, MANAGEMENT_APPROVAL_STATUS__C, MANAGER_NOTES__C, MANAGER__C, MEDDPICCC_SCORE__C, METRIC_NOTES__C, MKTO_SI__MARKETOANALYZER__C, MONTHS_TO_FULLY_RAMPED__C, NAME, NEW_ESTIMATOR__C, NEXTSTEP, NEXT_STEP_LAST_EDITED__C, NON_STANDARD_DEAL_NOTES__C, NON_STANDARD_DEAL__C, OPERATIONS_REVIEW_STATUS__C, OPPORTUNITY_ACCEPTED_DATE__C, OPPORTUNITY_ACCEPTED__C, OPPORTUNITY_SOURCE_OVERRIDE__C, OPPORTUNITY_SOURCE__C, ORDER_FORM_TCV__C, ORDER_SIGNATURE_DATE__C, OWNERID, PACKAGE_TYPE__C, PAGE_2_ROYALTY__C, PAPER_PROCESS_NOTES__C, PARTNER_SALES_REP__C, PARTNER_SOURCE__C, PLATFORM__C, PRICEBOOK2ID, PRIMARY_COMPETITOR__C, PRIMARY_QUOTE_ID__C, PRIOR_PRIMARY_QUOTE_ID__C, PROBABILITY, PRODUCTION_ORG_ID__C, PRODUCTS_OF_INTEREST__C, PROFESSIONAL_JUDGEMENT__C, PROJECTED_SI_PARTNER__C, PROJECT__C, PSACURRENT_SERVICE_ESTIMATE__C
        , PSE__ISPARENTOPPORTUNITYSERVICES__C, PSE__IS_CHANGE_REQUEST__C, PSE__IS_SERVICES_OPPORTUNITY__C, PSE__PARENT_OPPORTUNITY__C, PSE__PRACTICE__C, PSE__PRIMARY_PROJECT__C, PSE__REGION__C, PSE__SERVICES_ATTACHED_FROM_PRODUCTS__C, PSE__SERVICES_ATTACHED_PERCENT_FROM_PRODUCTS__C, PS_DELIVERY_OWNER__C, PS_GLOBAL_REGION__C, PS_NA_REGION__C, PS_NOTES__C, PURCHASE_ORDER_NUMBER__C, PURCHASE_ORDER__C, QUOTA_ATTAINMENT__C, RAMPED_ACV__C, RECORDTYPEID, REGION__C, RENEWAL_ACV__C, RENEWAL_DIRECTOR_NOTES__C, RENEWAL_DUE__C, RENEWAL_UPLIFT__C, RENEWAL__C, REVIVED_DATE__C, ROI_ANALYSIS_COMPLETED__C, SALES_OPS_APPROVED__C, SALES_OPS_BOOKING_NOTES__C, SALES_PLAYS__C, SCOPE_OF_PROJECT__C, SECONDARY_COMPETITORS__C, SEGMENTATION__C, SERVICES_BILLING_TYPE__C, SERVICES_SELLING_RATE__C, SERVICE_OPPORTUNITY_TYPES__C, SHIP_TO__C, SI_PARTNER_LOOKUP__C
        , SI_PARTNER_NOTES__C, SI_PARTNER__C, STAGE1_ENTRY_AVG_ACV__C, STAGENAME, STAGETONUMBER__C, STAGE_0_DATE_OF_ENTRY__C, STAGE_0_DATE_OF_EXIT__C, STAGE_0_DURATION__C, STAGE_1_DATE_OF_ENTRY__C, STAGE_1_DATE_OF_EXIT__C, STAGE_1_DURATION__C, STAGE_1_EXIT_AVG_ACV__C, STAGE_2_DATE_OF_ENTRY__C, STAGE_2_DATE_OF_EXIT__C, STAGE_2_DURATION__C, STAGE_3_DATE_OF_ENTRY__C, STAGE_3_DATE_OF_EXIT__C, STAGE_3_DURATION__C, STAGE_4_DATE_OF_ENTRY__C, STAGE_4_DATE_OF_EXIT__C, STAGE_4_DURATION__C, STAGE_5_DATE_OF_ENTRY__C, STAGE_5_DATE_OF_EXIT__C, STAGE_5_DURATION__C, STAGE_6_DATE_OF_ENTRY__C, STAGE_6_DATE_OF_EXIT__C, STAGE_6_DURATION__C, STAGE_7_DATE_OF_ENTRY__C, STAGE_7_DATE_OF_EXIT__C, STAGE_7_DURATION__C, STAGE_8_DATE_OF_ENTRY__C, STAGE_9_DATE_OF_ENTRY__C, STANDARD_TRAINING_REVENUE__C, SUBSCRIPTION_OPPORTUNITY__C, SUBSCRIPTION_START_DATE__C
        , SUB_REGION__C, SUB_TYPE__C, SUPPORT_AVG_ACV__C, SUPPORT_FIRST_YEAR_ACV__C, SUPPORT_RAMPED_ACV__C, SUPPORT_TOTAL_DEAL_VALUE__C, SYNCEDQUOTEID, SYSTEMMODSTAMP, TCV_NOT_COMMITTED__C, TERM_MONTHS__C, TOTAL_DEAL_VALUE__C, TOTAL_TRAINING_REVENUE__C, TSPC__CPDEALCOUNT__C, TYPE, VALID_UNTIL_DATE__C, VALUE_PROP_TO_ECONOMIC_BUYER__C, WEIGHTED_ACV__C, WHY_BUY_NOW__C, WIN_LOSS_DETAIL_NOTES_MGR__C, WIN_LOSS_DETAIL_NOTES__C, WIN_LOSS_FY_QUARTER__C, WIN_REASON__C, WON_LOST_DATE__C, X18_DIGIT_OLD_SFDC_ID__C, X18_DIGIT_SFDC_ID__C, _SDC_BATCHED_AT, _SDC_EXTRACTED_AT, _SDC_RECEIVED_AT, _SDC_SEQUENCE, _SDC_TABLE_VERSION, SEGMENTATION1__C, DE_BOOKED_OPPORTUNITY__C, CAMPAIGN_LIST_DEL__C, BUDGETARY_ESTIMATE_STATUS__C, ACCOUNT_INTEGRATION_STATUS__C, UPDATE__C, SALES_ORDER_INTERNAL_ID__C, SALES_ORDER_NUMBER__C, SALES_ORDER_STATUS__C
        , SALES_OPS_VERIFIED__C, REASON_FOR_DOWN_SELL__C, PARTNER__C, TOTAL_RENEWAL_DUE__C, SHIP_TO_NUM__C, BILL_TO_NUM__C, RENEWAL_UPLIFT_PERCENT__C, AVERAGE_ACV__C, APTTUS_APPROVAL__APPROVAL_STATUS__C, TOTALOPPORTUNITYQUANTITY, TSPC__CPDEAL__C, TSPC__CPSTAGEAP_EVENTBEHAVIOR__C, TSPC__CP_TEMPLATENAME__C, TSPC__CPSTAGEAP_ENABLED__C, DEAL_REVIEW_DATE__C, RENEWAL_DUE_FISCAL_QUARTER__C, RENEWAL_DUE_DATE__C, HAS_PWC_AS_PARTNER_SOURCE__C, CONGA_OPPORTUNITY_ID__C, ISEXCLUDEDFROMTERRITORY2FILTER, TERRITORY2ID, FISCAL_WEEK__C, GEO__C, SEGMENT__C, INFLUENCED_PARTNER_MANAGER__C, TOTAL_UPSELL_DOWNSELL__C, PARTNER_SOURCE_MANAGER__C, ANNUAL_RENEWAL__C, RENEWED_AMOUNT__C, TMP_UPDATE_ACCOUNT__C, AT_RISK_ACCOUNT_MANAGER_INVOLVEMENT__C, OPPORTUNITY_HOLD__C, OVERALL_SCORE__C, CSM_FORECAST__C, COVID_IMPACT__C, NPS__C, CSM_SENTIMENT__C
        , X18_DIGIT_ACCOUNT_SFDC_ID__C, RPA_BOT_STATUS__C, RENEWAL_PROBABILITY__C, RPA_BOT_ORDER_FORM_EMAILED__C, NEXT_STEP_FOR_BT_VC__C, NEXT_STEP_FOR_BT_VC_LAST_EDITED__C, OVERALL_HEALTH__C, RVP_UPSIDE__C, RVP_COMMIT__C, RVP_COMMENT__C, TOTAL_RVP_POTENTIAL__C, DESCRIPTION_FOR_BT_VC__C, NPS__C__ST, COVID_IMPACT__C__ST, TMP_FISCAL_WEEK_FORMULA__C, CREATED_FISCAL_YEAR__C, USE_CASE_LINE_OF_BUSINESS__C, USE_CASE__C, NEED__C, WIN_STRATEGY__C, DIFFERENTIATORS__C, CRITICAL_EVENT_DESCRIPTION__C, AGREED_SUCCESS_PATH__C, N_NETWORK_OF_POWER__C, WHY_NOW__C, ORDER_OF_EVENTS__C, O_OBJECTIONS_AND_RISKS__C, USE_CASE_DESCRIPTION__C, GAINED_VALUE__C, OPPORTUNITY_OWNER_PHONE__C, OPPORTUNITY_OWNER_NAME__C, OPPORTUNITY_OWNER_EMAIL__C, DOWNSELL_CHURN_SUB_CATEGORY__C, DOWNSELL_CHURN_CATEGORY__C, ENTRY_ACV__C, INCLUDE_IN_BIG_DEAL_REVIEW__C, EXECUTIVE_COMMENT__C
        , PRICE_INCREASE__C, C1_18_DIGIT_SFDC_ID__C, SUBSCRIPTION_RENEWED__C, SUBSCRIPTION_ATR__C, SUPPORT_RENEWED__C, SUPPORT_ATR__C, EXECUTIVE_JUDGEMENT_LOCK_FLAG__C, EXECUTIVE_FC_LOCK_FLAG__C
        , EXECUTIVE_FORECAST_CATEGORY__C, STAGE_1_DATE_ENTRY__C, APTS_RELATED_PSOD_AGREEMENT__C, CRO_COMMIT__C, WIN_ROOM__C, DEAL__C, NORTH_AMERICA_OWNER__C, SERVICE_SEGMENT__C, EMEA_OWNER__C, DERIVED_PS_GLOBAL_REGION__C
        , DERIVED_PS_NA_REGION__C, SECONDARY_PRODUCT_OF_INTEREST__C, ACCELERATOR_POSITIONED__C, EXPERT_SERVICES_POSITIONED__C, OTHER_COMPETITOR__C, PARTNER_REQUESTED__C, SALES_TAGS__C, IS_AUTOMATED_SERVICE_OPP__C, OWNERSMANAGEREMAIL__C, CREATEDBYMANAGEREMAIL1__C
        -- 2021/01/09
        , NULL AS OUTREACH_SEQUENCE_ATTRIBUTED__C                 
-- change -- remove older NULL AS from column
-- change -- add columns from the previous snap iteration as NULL AS 
 	, SNAP_LOAD_AT
FROM
	APTTUS_DW.SNAPSHOTS.OPPORTUNITY_A1_SNAP_1
;

-- change -- check counts to insure that the recently replaced snap now has all rows
DROP table APTTUS_DW.SNAPSHOTS.OPPORTUNITY_A1_SNAP_PRIOR;
Alter table APTTUS_DW.SNAPSHOTS.OPPORTUNITY_A1_SNAP_1 RENAME TO APTTUS_DW.SNAPSHOTS.OPPORTUNITY_A1_SNAP_PRIOR;	      
-- change first snap to be the recently replaced 
ALTER TABLE APTTUS_DW.SNAPSHOTS.OPPORTUNITY_A1_SNAP_1604725513858_1610186465728	RENAME TO APTTUS_DW.SNAPSHOTS.OPPORTUNITY_A1_SNAP_1
;
select count(*) from APTTUS_DW.SNAPSHOTS.OPPORTUNITY_A1_SNAP_1;

-- make changes below and then rebuild the history
CREATE OR REPLACE VIEW APTTUS_DW.SNAPSHOTS.OPPORTUNITY_A1_HISTORY 
COMMENT = 'Union OPPORTUNITY_A1 snapshots to make complete history' 
AS 
WITH the_union AS (
SELECT ACCOUNTID, ACTUAL_END_USER_REVENUE__C, ACTUAL_STANDARD_TRAINING_REVENUE__C, AGE_OF_DEAL__C, AGE_OF_THE_DEAL_DAYS__C, AIC_TECHNICAL_CONTACT__C, AMOUNT, AMS_AVG_ACV__C, AMS_RAMPED_ACV__C, AMS_TOTAL_DEAL_VALUE__C, ANY_SPECIAL_CONDITION__C, APPROVED_CONCESSION_AMOUNT__C, APTTUS_EXEC_SPONSOR__C, APTTUS_SERVICES_MAN_HRS__C, APTTUS_SERVICE_BOOKINGS__C, APTTUS_SE__C, APTTUS_TRAINER__C, ARE_EXPENSES_BILLABLE__C, AUTO_RENEWAL__C, BDR_ASSIGNED_TO_OPPTY__C, BDR_MANAGER_APPROVED__C, BIG_DEAL_TRACKER__C, BILL_TO__C
        , BUDGET_CONFIRMED__C, BUSINESS_NEEDS_AND_PAIN_POINTS__C, BYPASSVALIDATIONFORPROCESSBUILDER__C, CAMPAIGNID, CAMPAIGN_LIST__C, CHAMPION_NAME__C, CHAMPION_NOTES__C, CLOSEDATE, CLOSING_PLAN_PAPER_PROCESS__C, COACH_NAME_S__C, COACH_NOTES__C, COMMISSION_ACV__C, COMMISSION_ELIGIBLE__C, COMMISSION_NOTES__C, COMPELLING_EVENT__C, COMPETITION_NOTES__C, CONTACT__C, CONTINGENCY_AVG_ACV__C, CONTINGENCY_END_DATE__C, CONTINGENCY_FIRST_YEAR_ACV__C, CONTINGENCY_NOTES__C, CONTINGENCY_RAMPED_ACV__C, CONTINGENCY_TYPE__C
        , CONTINGENCY__C, CREATEDBYID, CREATEDDATE, CREATED_BY_BDR_GROUP__C, CREATED_REVIVED_DATE__C, CURRENCYISOCODE, DATE_OF_PROVISIONING__C, DATE_OF_SUBMISSION__C, DEAL_DESK_REVIEWER__C, DEAL_DESK_STATUS__C, DEAL_TYPE__C, DECISION_CRITERIA_NOTES__C, DECISION_PROCESS_NOTES__C, DECISION_PROCESS__C, DESCRIPTION, DE_BOOK__C, DISCOVERY_COMPLETED__C, DO_WE_FULFILL_CUST_DECISION_CRITERIA__C, DO_WE_HAVE_A_CHAMPION_SUPPORTING_DEAL__C, DO_WE_HAVE_SOMEONE_FILTERING_INFORMATION__C, DSCORGPKG__ATTRIBUTED_TO_DISCOVERORG__C
        , DSCORGPKG__CONVERTED_FROM_DISCOVERORG_DATA__C, DYNAMICS_GUID__C, ECONOMIC_BUYER_NAME_S__C, ECONOMIC_BUYER_NOTES__C, EMPTORIS_SWAP__C, END_USER_REVENUE__C, ESTIMATED_LAUNCH_POINTS__C, ESTIMATED_OF_USERS__C, ESTIMATED_SERVICES_REVENUE__C, EST_HOURS_FROM_NEW_ESTIMATOR__C, EVALUATION_PROCESS__C, EVALUATION_TIME_FRAME__C, EXPANSION__C, EXPECTEDREVENUE, EXPECTED_GO_LIVE_DATE__C, EXPECTED_START_DATE__C, EXPECTED_TRAINING_DELIVERY__C, FINANCE_REVIEW_STATUS__C, FIRST_YEAR_ACV__C, FISCAL, FISCALQUARTER, FISCALYEAR, FOCUSED_VERTICAL__C, FORECASTCATEGORY, FORECASTCATEGORYNAME, FORECAST_CATEGORY__C
        , FX_RATE__C, GTM_PARTNER_NOTES__C, HASOPENACTIVITY, HASOPPORTUNITYLINEITEM, HASOVERDUETASK, HAVE_WE_IDENTIFIED_THE_COMPETITION__C, HIGHEST_ACHIEVED_STAGE_VALUE__C, HIGHEST_ACHIEVED_STAGE__C, HIGHEST_STAGE_VALUE__C, ID, IDENTIFY_PAIN_NOTES__C, IDENTIFY_PAIN__C, IMPLEMENTATION_PRIME__C, IMPLEMENTATION_TIMEFRAME__C, INBOUND_OUTBOUND_OPPORTUNITY__C, IN_QUARTER_BILLING__C, ISCLOSED, ISDELETED, ISPRIVATE, ISR__C, ISSPLIT, ISWON, IS_CLOSED_LOST_EMAIL_SENT__C, IS_CLOSED_WON_EMAIL_SENT__C, IS_THERE_A_RFP__C, IS_THE_BUSINESS_CASE_QUANTIFIED__C, KEY_NOTES__C, LASTACTIVITYDATE, LASTMODIFIEDBYID, LASTMODIFIEDDATE, LASTREFERENCEDDATE, LASTVIEWEDDATE, LEADSOURCE, LEAD_SOURCE_GLOBAL__C, LEGACY_CREATEDDATE__C, LEGACY_OWNER_NAME__C, LEGAL_REVIEW_STATUS__C, LID__IS_INFLUENCED__C, LIST_PRICE__C, LOCKED__C, LOSS_REASON__C, LOSS_SUB_CATEGORY__C
        , MANAGED_SERVICES_BOOKINGS__C, MANAGEMENT_APPROVAL_STATUS__C, MANAGER_NOTES__C, MANAGER__C, MEDDPICCC_SCORE__C, METRIC_NOTES__C, MKTO_SI__MARKETOANALYZER__C, MONTHS_TO_FULLY_RAMPED__C, NAME, NEW_ESTIMATOR__C, NEXTSTEP, NEXT_STEP_LAST_EDITED__C, NON_STANDARD_DEAL_NOTES__C, NON_STANDARD_DEAL__C, OPERATIONS_REVIEW_STATUS__C, OPPORTUNITY_ACCEPTED_DATE__C, OPPORTUNITY_ACCEPTED__C, OPPORTUNITY_SOURCE_OVERRIDE__C, OPPORTUNITY_SOURCE__C, ORDER_FORM_TCV__C, ORDER_SIGNATURE_DATE__C, OWNERID, PACKAGE_TYPE__C, PAGE_2_ROYALTY__C, PAPER_PROCESS_NOTES__C, PARTNER_SALES_REP__C, PARTNER_SOURCE__C, PLATFORM__C, PRICEBOOK2ID, PRIMARY_COMPETITOR__C, PRIMARY_QUOTE_ID__C, PRIOR_PRIMARY_QUOTE_ID__C, PROBABILITY, PRODUCTION_ORG_ID__C, PRODUCTS_OF_INTEREST__C, PROFESSIONAL_JUDGEMENT__C, PROJECTED_SI_PARTNER__C, PROJECT__C, PSACURRENT_SERVICE_ESTIMATE__C
        , PSE__ISPARENTOPPORTUNITYSERVICES__C, PSE__IS_CHANGE_REQUEST__C, PSE__IS_SERVICES_OPPORTUNITY__C, PSE__PARENT_OPPORTUNITY__C, PSE__PRACTICE__C, PSE__PRIMARY_PROJECT__C, PSE__REGION__C, PSE__SERVICES_ATTACHED_FROM_PRODUCTS__C, PSE__SERVICES_ATTACHED_PERCENT_FROM_PRODUCTS__C, PS_DELIVERY_OWNER__C, PS_GLOBAL_REGION__C, PS_NA_REGION__C, PS_NOTES__C, PURCHASE_ORDER_NUMBER__C, PURCHASE_ORDER__C, QUOTA_ATTAINMENT__C, RAMPED_ACV__C, RECORDTYPEID, REGION__C, RENEWAL_ACV__C, RENEWAL_DIRECTOR_NOTES__C, RENEWAL_DUE__C, RENEWAL_UPLIFT__C, RENEWAL__C, REVIVED_DATE__C, ROI_ANALYSIS_COMPLETED__C, SALES_OPS_APPROVED__C, SALES_OPS_BOOKING_NOTES__C, SALES_PLAYS__C, SCOPE_OF_PROJECT__C, SECONDARY_COMPETITORS__C, SEGMENTATION__C, SERVICES_BILLING_TYPE__C, SERVICES_SELLING_RATE__C, SERVICE_OPPORTUNITY_TYPES__C, SHIP_TO__C, SI_PARTNER_LOOKUP__C
        , SI_PARTNER_NOTES__C, SI_PARTNER__C, STAGE1_ENTRY_AVG_ACV__C, STAGENAME, STAGETONUMBER__C, STAGE_0_DATE_OF_ENTRY__C, STAGE_0_DATE_OF_EXIT__C, STAGE_0_DURATION__C, STAGE_1_DATE_OF_ENTRY__C, STAGE_1_DATE_OF_EXIT__C, STAGE_1_DURATION__C, STAGE_1_EXIT_AVG_ACV__C, STAGE_2_DATE_OF_ENTRY__C, STAGE_2_DATE_OF_EXIT__C, STAGE_2_DURATION__C, STAGE_3_DATE_OF_ENTRY__C, STAGE_3_DATE_OF_EXIT__C, STAGE_3_DURATION__C, STAGE_4_DATE_OF_ENTRY__C, STAGE_4_DATE_OF_EXIT__C, STAGE_4_DURATION__C, STAGE_5_DATE_OF_ENTRY__C, STAGE_5_DATE_OF_EXIT__C, STAGE_5_DURATION__C, STAGE_6_DATE_OF_ENTRY__C, STAGE_6_DATE_OF_EXIT__C, STAGE_6_DURATION__C, STAGE_7_DATE_OF_ENTRY__C, STAGE_7_DATE_OF_EXIT__C, STAGE_7_DURATION__C, STAGE_8_DATE_OF_ENTRY__C, STAGE_9_DATE_OF_ENTRY__C, STANDARD_TRAINING_REVENUE__C, SUBSCRIPTION_OPPORTUNITY__C, SUBSCRIPTION_START_DATE__C
        , SUB_REGION__C, SUB_TYPE__C, SUPPORT_AVG_ACV__C, SUPPORT_FIRST_YEAR_ACV__C, SUPPORT_RAMPED_ACV__C, SUPPORT_TOTAL_DEAL_VALUE__C, SYNCEDQUOTEID, SYSTEMMODSTAMP, TCV_NOT_COMMITTED__C, TERM_MONTHS__C, TOTAL_DEAL_VALUE__C, TOTAL_TRAINING_REVENUE__C, TSPC__CPDEALCOUNT__C, TYPE, VALID_UNTIL_DATE__C, VALUE_PROP_TO_ECONOMIC_BUYER__C, WEIGHTED_ACV__C, WHY_BUY_NOW__C, WIN_LOSS_DETAIL_NOTES_MGR__C, WIN_LOSS_DETAIL_NOTES__C, WIN_LOSS_FY_QUARTER__C, WIN_REASON__C, WON_LOST_DATE__C, X18_DIGIT_OLD_SFDC_ID__C, X18_DIGIT_SFDC_ID__C, _SDC_BATCHED_AT, _SDC_EXTRACTED_AT, _SDC_RECEIVED_AT, _SDC_SEQUENCE, _SDC_TABLE_VERSION, SEGMENTATION1__C, DE_BOOKED_OPPORTUNITY__C, CAMPAIGN_LIST_DEL__C, BUDGETARY_ESTIMATE_STATUS__C, ACCOUNT_INTEGRATION_STATUS__C, UPDATE__C, SALES_ORDER_INTERNAL_ID__C, SALES_ORDER_NUMBER__C, SALES_ORDER_STATUS__C
        , SALES_OPS_VERIFIED__C, REASON_FOR_DOWN_SELL__C, PARTNER__C, TOTAL_RENEWAL_DUE__C, SHIP_TO_NUM__C, BILL_TO_NUM__C, RENEWAL_UPLIFT_PERCENT__C, AVERAGE_ACV__C, APTTUS_APPROVAL__APPROVAL_STATUS__C, TOTALOPPORTUNITYQUANTITY, TSPC__CPDEAL__C, TSPC__CPSTAGEAP_EVENTBEHAVIOR__C, TSPC__CP_TEMPLATENAME__C, TSPC__CPSTAGEAP_ENABLED__C, DEAL_REVIEW_DATE__C, RENEWAL_DUE_FISCAL_QUARTER__C, RENEWAL_DUE_DATE__C, HAS_PWC_AS_PARTNER_SOURCE__C, CONGA_OPPORTUNITY_ID__C, ISEXCLUDEDFROMTERRITORY2FILTER, TERRITORY2ID, FISCAL_WEEK__C, GEO__C, SEGMENT__C, INFLUENCED_PARTNER_MANAGER__C, TOTAL_UPSELL_DOWNSELL__C, PARTNER_SOURCE_MANAGER__C, ANNUAL_RENEWAL__C, RENEWED_AMOUNT__C, TMP_UPDATE_ACCOUNT__C, AT_RISK_ACCOUNT_MANAGER_INVOLVEMENT__C, OPPORTUNITY_HOLD__C, OVERALL_SCORE__C, CSM_FORECAST__C, COVID_IMPACT__C, NPS__C, CSM_SENTIMENT__C
        , X18_DIGIT_ACCOUNT_SFDC_ID__C, RPA_BOT_STATUS__C, RENEWAL_PROBABILITY__C, RPA_BOT_ORDER_FORM_EMAILED__C, NEXT_STEP_FOR_BT_VC__C, NEXT_STEP_FOR_BT_VC_LAST_EDITED__C, OVERALL_HEALTH__C, RVP_UPSIDE__C, RVP_COMMIT__C, RVP_COMMENT__C, TOTAL_RVP_POTENTIAL__C, DESCRIPTION_FOR_BT_VC__C, NPS__C__ST, COVID_IMPACT__C__ST, TMP_FISCAL_WEEK_FORMULA__C, CREATED_FISCAL_YEAR__C, USE_CASE_LINE_OF_BUSINESS__C, USE_CASE__C, NEED__C, WIN_STRATEGY__C, DIFFERENTIATORS__C, CRITICAL_EVENT_DESCRIPTION__C, AGREED_SUCCESS_PATH__C, N_NETWORK_OF_POWER__C, WHY_NOW__C, ORDER_OF_EVENTS__C, O_OBJECTIONS_AND_RISKS__C, USE_CASE_DESCRIPTION__C, GAINED_VALUE__C, OPPORTUNITY_OWNER_PHONE__C, OPPORTUNITY_OWNER_NAME__C, OPPORTUNITY_OWNER_EMAIL__C, DOWNSELL_CHURN_SUB_CATEGORY__C, DOWNSELL_CHURN_CATEGORY__C, ENTRY_ACV__C, INCLUDE_IN_BIG_DEAL_REVIEW__C, EXECUTIVE_COMMENT__C
        , PRICE_INCREASE__C, C1_18_DIGIT_SFDC_ID__C, SUBSCRIPTION_RENEWED__C, SUBSCRIPTION_ATR__C, SUPPORT_RENEWED__C, SUPPORT_ATR__C, EXECUTIVE_JUDGEMENT_LOCK_FLAG__C, EXECUTIVE_FC_LOCK_FLAG__C
        , EXECUTIVE_FORECAST_CATEGORY__C, STAGE_1_DATE_ENTRY__C, APTS_RELATED_PSOD_AGREEMENT__C, CRO_COMMIT__C, WIN_ROOM__C, DEAL__C, NORTH_AMERICA_OWNER__C, SERVICE_SEGMENT__C, EMEA_OWNER__C, DERIVED_PS_GLOBAL_REGION__C
        , DERIVED_PS_NA_REGION__C, SECONDARY_PRODUCT_OF_INTEREST__C, ACCELERATOR_POSITIONED__C, EXPERT_SERVICES_POSITIONED__C, OTHER_COMPETITOR__C, PARTNER_REQUESTED__C, SALES_TAGS__C, IS_AUTOMATED_SERVICE_OPP__C, OWNERSMANAGEREMAIL__C, CREATEDBYMANAGEREMAIL1__C
        -- 2021/01/09
        , OUTREACH_SEQUENCE_ATTRIBUTED__C
        -- 2021/01/11
        , NEXT_STEPS__C
        , ALLOW_CLOSE_DATE_TO_TODAYS__C
-- change -- add latest columns        
	, SNAP_LOAD_AT
FROM
-- change -- update to most recent snap
	APTTUS_DW.SNAPSHOTS.OPPORTUNITY_A1_SNAP_1604725513858_1610359276293
UNION
SELECT ACCOUNTID, ACTUAL_END_USER_REVENUE__C, ACTUAL_STANDARD_TRAINING_REVENUE__C, AGE_OF_DEAL__C, AGE_OF_THE_DEAL_DAYS__C, AIC_TECHNICAL_CONTACT__C, AMOUNT, AMS_AVG_ACV__C, AMS_RAMPED_ACV__C, AMS_TOTAL_DEAL_VALUE__C, ANY_SPECIAL_CONDITION__C, APPROVED_CONCESSION_AMOUNT__C, APTTUS_EXEC_SPONSOR__C, APTTUS_SERVICES_MAN_HRS__C, APTTUS_SERVICE_BOOKINGS__C, APTTUS_SE__C, APTTUS_TRAINER__C, ARE_EXPENSES_BILLABLE__C, AUTO_RENEWAL__C, BDR_ASSIGNED_TO_OPPTY__C, BDR_MANAGER_APPROVED__C, BIG_DEAL_TRACKER__C, BILL_TO__C
        , BUDGET_CONFIRMED__C, BUSINESS_NEEDS_AND_PAIN_POINTS__C, BYPASSVALIDATIONFORPROCESSBUILDER__C, CAMPAIGNID, CAMPAIGN_LIST__C, CHAMPION_NAME__C, CHAMPION_NOTES__C, CLOSEDATE, CLOSING_PLAN_PAPER_PROCESS__C, COACH_NAME_S__C, COACH_NOTES__C, COMMISSION_ACV__C, COMMISSION_ELIGIBLE__C, COMMISSION_NOTES__C, COMPELLING_EVENT__C, COMPETITION_NOTES__C, CONTACT__C, CONTINGENCY_AVG_ACV__C, CONTINGENCY_END_DATE__C, CONTINGENCY_FIRST_YEAR_ACV__C, CONTINGENCY_NOTES__C, CONTINGENCY_RAMPED_ACV__C, CONTINGENCY_TYPE__C
        , CONTINGENCY__C, CREATEDBYID, CREATEDDATE, CREATED_BY_BDR_GROUP__C, CREATED_REVIVED_DATE__C, CURRENCYISOCODE, DATE_OF_PROVISIONING__C, DATE_OF_SUBMISSION__C, DEAL_DESK_REVIEWER__C, DEAL_DESK_STATUS__C, DEAL_TYPE__C, DECISION_CRITERIA_NOTES__C, DECISION_PROCESS_NOTES__C, DECISION_PROCESS__C, DESCRIPTION, DE_BOOK__C, DISCOVERY_COMPLETED__C, DO_WE_FULFILL_CUST_DECISION_CRITERIA__C, DO_WE_HAVE_A_CHAMPION_SUPPORTING_DEAL__C, DO_WE_HAVE_SOMEONE_FILTERING_INFORMATION__C, DSCORGPKG__ATTRIBUTED_TO_DISCOVERORG__C
        , DSCORGPKG__CONVERTED_FROM_DISCOVERORG_DATA__C, DYNAMICS_GUID__C, ECONOMIC_BUYER_NAME_S__C, ECONOMIC_BUYER_NOTES__C, EMPTORIS_SWAP__C, END_USER_REVENUE__C, ESTIMATED_LAUNCH_POINTS__C, ESTIMATED_OF_USERS__C, ESTIMATED_SERVICES_REVENUE__C, EST_HOURS_FROM_NEW_ESTIMATOR__C, EVALUATION_PROCESS__C, EVALUATION_TIME_FRAME__C, EXPANSION__C, EXPECTEDREVENUE, EXPECTED_GO_LIVE_DATE__C, EXPECTED_START_DATE__C, EXPECTED_TRAINING_DELIVERY__C, FINANCE_REVIEW_STATUS__C, FIRST_YEAR_ACV__C, FISCAL, FISCALQUARTER, FISCALYEAR, FOCUSED_VERTICAL__C, FORECASTCATEGORY, FORECASTCATEGORYNAME, FORECAST_CATEGORY__C
        , FX_RATE__C, GTM_PARTNER_NOTES__C, HASOPENACTIVITY, HASOPPORTUNITYLINEITEM, HASOVERDUETASK, HAVE_WE_IDENTIFIED_THE_COMPETITION__C, HIGHEST_ACHIEVED_STAGE_VALUE__C, HIGHEST_ACHIEVED_STAGE__C, HIGHEST_STAGE_VALUE__C, ID, IDENTIFY_PAIN_NOTES__C, IDENTIFY_PAIN__C, IMPLEMENTATION_PRIME__C, IMPLEMENTATION_TIMEFRAME__C, INBOUND_OUTBOUND_OPPORTUNITY__C, IN_QUARTER_BILLING__C, ISCLOSED, ISDELETED, ISPRIVATE, ISR__C, ISSPLIT, ISWON, IS_CLOSED_LOST_EMAIL_SENT__C, IS_CLOSED_WON_EMAIL_SENT__C, IS_THERE_A_RFP__C, IS_THE_BUSINESS_CASE_QUANTIFIED__C, KEY_NOTES__C, LASTACTIVITYDATE, LASTMODIFIEDBYID, LASTMODIFIEDDATE, LASTREFERENCEDDATE, LASTVIEWEDDATE, LEADSOURCE, LEAD_SOURCE_GLOBAL__C, LEGACY_CREATEDDATE__C, LEGACY_OWNER_NAME__C, LEGAL_REVIEW_STATUS__C, LID__IS_INFLUENCED__C, LIST_PRICE__C, LOCKED__C, LOSS_REASON__C, LOSS_SUB_CATEGORY__C
        , MANAGED_SERVICES_BOOKINGS__C, MANAGEMENT_APPROVAL_STATUS__C, MANAGER_NOTES__C, MANAGER__C, MEDDPICCC_SCORE__C, METRIC_NOTES__C, MKTO_SI__MARKETOANALYZER__C, MONTHS_TO_FULLY_RAMPED__C, NAME, NEW_ESTIMATOR__C, NEXTSTEP, NEXT_STEP_LAST_EDITED__C, NON_STANDARD_DEAL_NOTES__C, NON_STANDARD_DEAL__C, OPERATIONS_REVIEW_STATUS__C, OPPORTUNITY_ACCEPTED_DATE__C, OPPORTUNITY_ACCEPTED__C, OPPORTUNITY_SOURCE_OVERRIDE__C, OPPORTUNITY_SOURCE__C, ORDER_FORM_TCV__C, ORDER_SIGNATURE_DATE__C, OWNERID, PACKAGE_TYPE__C, PAGE_2_ROYALTY__C, PAPER_PROCESS_NOTES__C, PARTNER_SALES_REP__C, PARTNER_SOURCE__C, PLATFORM__C, PRICEBOOK2ID, PRIMARY_COMPETITOR__C, PRIMARY_QUOTE_ID__C, PRIOR_PRIMARY_QUOTE_ID__C, PROBABILITY, PRODUCTION_ORG_ID__C, PRODUCTS_OF_INTEREST__C, PROFESSIONAL_JUDGEMENT__C, PROJECTED_SI_PARTNER__C, PROJECT__C, PSACURRENT_SERVICE_ESTIMATE__C
        , PSE__ISPARENTOPPORTUNITYSERVICES__C, PSE__IS_CHANGE_REQUEST__C, PSE__IS_SERVICES_OPPORTUNITY__C, PSE__PARENT_OPPORTUNITY__C, PSE__PRACTICE__C, PSE__PRIMARY_PROJECT__C, PSE__REGION__C, PSE__SERVICES_ATTACHED_FROM_PRODUCTS__C, PSE__SERVICES_ATTACHED_PERCENT_FROM_PRODUCTS__C, PS_DELIVERY_OWNER__C, PS_GLOBAL_REGION__C, PS_NA_REGION__C, PS_NOTES__C, PURCHASE_ORDER_NUMBER__C, PURCHASE_ORDER__C, QUOTA_ATTAINMENT__C, RAMPED_ACV__C, RECORDTYPEID, REGION__C, RENEWAL_ACV__C, RENEWAL_DIRECTOR_NOTES__C, RENEWAL_DUE__C, RENEWAL_UPLIFT__C, RENEWAL__C, REVIVED_DATE__C, ROI_ANALYSIS_COMPLETED__C, SALES_OPS_APPROVED__C, SALES_OPS_BOOKING_NOTES__C, SALES_PLAYS__C, SCOPE_OF_PROJECT__C, SECONDARY_COMPETITORS__C, SEGMENTATION__C, SERVICES_BILLING_TYPE__C, SERVICES_SELLING_RATE__C, SERVICE_OPPORTUNITY_TYPES__C, SHIP_TO__C, SI_PARTNER_LOOKUP__C
        , SI_PARTNER_NOTES__C, SI_PARTNER__C, STAGE1_ENTRY_AVG_ACV__C, STAGENAME, STAGETONUMBER__C, STAGE_0_DATE_OF_ENTRY__C, STAGE_0_DATE_OF_EXIT__C, STAGE_0_DURATION__C, STAGE_1_DATE_OF_ENTRY__C, STAGE_1_DATE_OF_EXIT__C, STAGE_1_DURATION__C, STAGE_1_EXIT_AVG_ACV__C, STAGE_2_DATE_OF_ENTRY__C, STAGE_2_DATE_OF_EXIT__C, STAGE_2_DURATION__C, STAGE_3_DATE_OF_ENTRY__C, STAGE_3_DATE_OF_EXIT__C, STAGE_3_DURATION__C, STAGE_4_DATE_OF_ENTRY__C, STAGE_4_DATE_OF_EXIT__C, STAGE_4_DURATION__C, STAGE_5_DATE_OF_ENTRY__C, STAGE_5_DATE_OF_EXIT__C, STAGE_5_DURATION__C, STAGE_6_DATE_OF_ENTRY__C, STAGE_6_DATE_OF_EXIT__C, STAGE_6_DURATION__C, STAGE_7_DATE_OF_ENTRY__C, STAGE_7_DATE_OF_EXIT__C, STAGE_7_DURATION__C, STAGE_8_DATE_OF_ENTRY__C, STAGE_9_DATE_OF_ENTRY__C, STANDARD_TRAINING_REVENUE__C, SUBSCRIPTION_OPPORTUNITY__C, SUBSCRIPTION_START_DATE__C
        , SUB_REGION__C, SUB_TYPE__C, SUPPORT_AVG_ACV__C, SUPPORT_FIRST_YEAR_ACV__C, SUPPORT_RAMPED_ACV__C, SUPPORT_TOTAL_DEAL_VALUE__C, SYNCEDQUOTEID, SYSTEMMODSTAMP, TCV_NOT_COMMITTED__C, TERM_MONTHS__C, TOTAL_DEAL_VALUE__C, TOTAL_TRAINING_REVENUE__C, TSPC__CPDEALCOUNT__C, TYPE, VALID_UNTIL_DATE__C, VALUE_PROP_TO_ECONOMIC_BUYER__C, WEIGHTED_ACV__C, WHY_BUY_NOW__C, WIN_LOSS_DETAIL_NOTES_MGR__C, WIN_LOSS_DETAIL_NOTES__C, WIN_LOSS_FY_QUARTER__C, WIN_REASON__C, WON_LOST_DATE__C, X18_DIGIT_OLD_SFDC_ID__C, X18_DIGIT_SFDC_ID__C, _SDC_BATCHED_AT, _SDC_EXTRACTED_AT, _SDC_RECEIVED_AT, _SDC_SEQUENCE, _SDC_TABLE_VERSION, SEGMENTATION1__C, DE_BOOKED_OPPORTUNITY__C, CAMPAIGN_LIST_DEL__C, BUDGETARY_ESTIMATE_STATUS__C, ACCOUNT_INTEGRATION_STATUS__C, UPDATE__C, SALES_ORDER_INTERNAL_ID__C, SALES_ORDER_NUMBER__C, SALES_ORDER_STATUS__C
        , SALES_OPS_VERIFIED__C, REASON_FOR_DOWN_SELL__C, PARTNER__C, TOTAL_RENEWAL_DUE__C, SHIP_TO_NUM__C, BILL_TO_NUM__C, RENEWAL_UPLIFT_PERCENT__C, AVERAGE_ACV__C, APTTUS_APPROVAL__APPROVAL_STATUS__C, TOTALOPPORTUNITYQUANTITY, TSPC__CPDEAL__C, TSPC__CPSTAGEAP_EVENTBEHAVIOR__C, TSPC__CP_TEMPLATENAME__C, TSPC__CPSTAGEAP_ENABLED__C, DEAL_REVIEW_DATE__C, RENEWAL_DUE_FISCAL_QUARTER__C, RENEWAL_DUE_DATE__C, HAS_PWC_AS_PARTNER_SOURCE__C, CONGA_OPPORTUNITY_ID__C, ISEXCLUDEDFROMTERRITORY2FILTER, TERRITORY2ID, FISCAL_WEEK__C, GEO__C, SEGMENT__C, INFLUENCED_PARTNER_MANAGER__C, TOTAL_UPSELL_DOWNSELL__C, PARTNER_SOURCE_MANAGER__C, ANNUAL_RENEWAL__C, RENEWED_AMOUNT__C, TMP_UPDATE_ACCOUNT__C, AT_RISK_ACCOUNT_MANAGER_INVOLVEMENT__C, OPPORTUNITY_HOLD__C, OVERALL_SCORE__C, CSM_FORECAST__C, COVID_IMPACT__C, NPS__C, CSM_SENTIMENT__C
        , X18_DIGIT_ACCOUNT_SFDC_ID__C, RPA_BOT_STATUS__C, RENEWAL_PROBABILITY__C, RPA_BOT_ORDER_FORM_EMAILED__C, NEXT_STEP_FOR_BT_VC__C, NEXT_STEP_FOR_BT_VC_LAST_EDITED__C, OVERALL_HEALTH__C, RVP_UPSIDE__C, RVP_COMMIT__C, RVP_COMMENT__C, TOTAL_RVP_POTENTIAL__C, DESCRIPTION_FOR_BT_VC__C, NPS__C__ST, COVID_IMPACT__C__ST, TMP_FISCAL_WEEK_FORMULA__C, CREATED_FISCAL_YEAR__C, USE_CASE_LINE_OF_BUSINESS__C, USE_CASE__C, NEED__C, WIN_STRATEGY__C, DIFFERENTIATORS__C, CRITICAL_EVENT_DESCRIPTION__C, AGREED_SUCCESS_PATH__C, N_NETWORK_OF_POWER__C, WHY_NOW__C, ORDER_OF_EVENTS__C, O_OBJECTIONS_AND_RISKS__C, USE_CASE_DESCRIPTION__C, GAINED_VALUE__C, OPPORTUNITY_OWNER_PHONE__C, OPPORTUNITY_OWNER_NAME__C, OPPORTUNITY_OWNER_EMAIL__C, DOWNSELL_CHURN_SUB_CATEGORY__C, DOWNSELL_CHURN_CATEGORY__C, ENTRY_ACV__C, INCLUDE_IN_BIG_DEAL_REVIEW__C, EXECUTIVE_COMMENT__C
        , PRICE_INCREASE__C, C1_18_DIGIT_SFDC_ID__C, SUBSCRIPTION_RENEWED__C, SUBSCRIPTION_ATR__C, SUPPORT_RENEWED__C, SUPPORT_ATR__C, EXECUTIVE_JUDGEMENT_LOCK_FLAG__C, EXECUTIVE_FC_LOCK_FLAG__C
        , EXECUTIVE_FORECAST_CATEGORY__C, STAGE_1_DATE_ENTRY__C, APTS_RELATED_PSOD_AGREEMENT__C, CRO_COMMIT__C, WIN_ROOM__C, DEAL__C, NORTH_AMERICA_OWNER__C, SERVICE_SEGMENT__C, EMEA_OWNER__C, DERIVED_PS_GLOBAL_REGION__C
        , DERIVED_PS_NA_REGION__C, SECONDARY_PRODUCT_OF_INTEREST__C, ACCELERATOR_POSITIONED__C, EXPERT_SERVICES_POSITIONED__C, OTHER_COMPETITOR__C, PARTNER_REQUESTED__C, SALES_TAGS__C, IS_AUTOMATED_SERVICE_OPP__C, OWNERSMANAGEREMAIL__C, CREATEDBYMANAGEREMAIL1__C
        -- 2021/01/09
        , OUTREACH_SEQUENCE_ATTRIBUTED__C
        -- 2021/01/11
        , NULL AS NEXT_STEPS__C
        , NULL AS ALLOW_CLOSE_DATE_TO_TODAYS__C
-- change -- remove NULL AS from previous round
-- change -- ADD newest Columns as NULL AS  	
        , SNAP_LOAD_AT		
FROM
	APTTUS_DW.SNAPSHOTS.OPPORTUNITY_A1_SNAP_1
)
, the_unique AS (
	SELECT
		ID
		, _SDC_EXTRACTED_AT
		, MAX(SNAP_LOAD_AT) AS SNAP_LOAD_AT
	FROM the_union
	GROUP BY ID
		    , _SDC_EXTRACTED_AT 
)
SELECT
	A.*
	, to_date(SYSTEMMODSTAMP) AS ACTIVITY_DATE
	, dateadd(DAY, -1, to_date(A."_SDC_EXTRACTED_AT")) AS EXTRACT_DATE
	, dateadd(DAY, -1, to_date(A."SNAP_LOAD_AT")) AS REPORTING_DATE
FROM          the_union A
INNER JOIN    the_unique B 
           ON A.ID = B.ID
	       AND A._SDC_EXTRACTED_AT = B._SDC_EXTRACTED_AT
	       AND A.SNAP_LOAD_AT = B.SNAP_LOAD_AT 
;

-- RUN duplicate detector to be sure you haven't created duplicates in History View
SELECT count(*)
     , ID
     , _SDC_EXTRACTED_AT 
FROM APTTUS_DW.SNAPSHOTS.OPPORTUNITY_A1_HISTORY
group by ID
       , _SDC_EXTRACTED_AT 
having count(*) > 1
-- If 0 not returned then there are duplicates!
;

select count(distinct ID)
FROM APTTUS_DW.SNAPSHOTS.OPPORTUNITY_A1_HISTORY
-- 29004 
;

select count(distinct ID, Activity_Date )
FROM APTTUS_DW.SNAPSHOTS.OPPORTUNITY_A1_HISTORY
-- 44840 
;

