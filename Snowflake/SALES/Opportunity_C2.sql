-- APTTUS_DW.SF_PRODUCTION."Opportunity_C2" source

CREATE OR REPLACE VIEW APTTUS_DW.SF_PRODUCTION."Opportunity_C2"  COMMENT = 'all purpose Opportunity view for Blended Conga2.0
10/09 Greg added snapshot control fields
' AS 
SELECT 'Conga1.0' AS CRM_SOURCE,
    NULL AS A1_PARTNER,
    ACCOUNTID AS ACCOUNT_ID,
    ACCOUNT_NAME,
    ACCOUNT_OWNER_NAME,
    ACCOUNTURL AS ACCOUNT_URL,
    (FUTURE_AVG_MRR_TOTAL * 12) AS ANNUAL_RENEWAL,
    ARR::NUMBER(19,2) AS ARR,
    OPPORTUNITY_AGE AS AGE_DAYS,
    (OPPORTUNITY_AGE/365)*12 AS AGE_MONTHS,
    AVERAGE_ACV::NUMBER(19,2) AS AVERAGE_ACV,
    BILLING_FREQUENCY__C AS BILLING_FREQUENCY,
    BOOKINGS_DATE,
    OPPORTUNITY_BOOKING_STAMP__C AS BOOKING_STAMP,
    PARTNER__C AS C1_PARTNER,
    PREDICTED_C2_STAGE AS C2_STAGE,
    PREDICTED_C2_TYPE AS C2_TYPE,
    CAMPAIGNID AS CAMPAIGN_ID,
    BOOKINGS_DATE AS CLOSE_BOOKINGS_DATE,
    CLOSED_REASON_CATEGORY,
    NULL AS CLOSED_REASON_DETAILS,
    CLOSED_REASON_NOTES,
    NULL AS CLOSED_REASON_SUBCATEGORY_LOSS,
    PRIMARY_CONTACT__C AS CONTACT_ID,
    CREATEDDATE AS CREATED_DATE,
    'USD' AS CURRENCY,
    1.0 AS CURRENCY_CONVERSION_RATE,
    CURRENT_AVG_MRR_TOTAL,
    CUSTOMER_SUCCESS_MANAGERID__C AS CUSTOMER_SUPPORT_ID,
    CUSTOMER_SUCCESS_MANAGER_NAME AS CUSTOMER_SUPPORT_NAME,
    DISCOUNT_RECAPTURE_MRR::NUMBER(19,2) AS DISCOUNT_RECAPTURE_MRR,
    NULL AS DOWNSELL_CHURN_CATEGORY, 
    NULL AS DOWNSELL_CHURN_SUB_CATEGORY,
    MRR_SUB_END AS END_DATE,
    ESTIMATED_CLOSE_DATE,
    NULL AS EXPANSION_DOLLARS,
    FIRST_YEAR_BILLINGS::NUMBER(19,2) AS FIRST_YEARS_BILLINGS,
    FISCAL_WEEK,
    FORECAST_CATEGORY,
    CASE
        WHEN GEO_NAME = 'NA'
           THEN 'AMER'
        ELSE GEO_NAME
    END AS GEO,
    HIGHEST_ACHIEVED_STAGE,
    NULL AS INBOUND_OUTBOUND_OPPORTUNITY,
    LAST_EDIT_DATE,
    LEAD_SOURCE,
    LEAD_SOURCE_DETAIL,
    MRR_SUB_END__C AS MRR_SUB_END,
    MRR_SUB_START__C  AS MRR_SUB_START,
    NET_NEW_MRR::NUMBER(19,2) AS NET_NEW_MRR,
    NEXTSTEP AS NEXT_STEP,
    NULL AS NEXT_STEP_LAST_EDITED,
    NN_DISCOUNT_RECAPTURE_ACV::NUMBER(19,2) AS NN_DISCOUNT_RECAPTURE_ACV,
    OPPTY_CHANNEL_SOURCE AS OPPORTUNITY_CHANNEL_SOURCE,
    OPPORTUNITY_ID,
    OPPORTUNITY_NAME,
    OPPORTUNITYURL AS OPPORTUNITY_URL,
    OPS_APPROVED,
    OPPORTUNITY_OWNER_GEO_STAMP__C AS OWNER_GEO_STAMP,
    OWNERID AS OWNER_ID,
    OWNER_NAME,
    OWNER_ROLE,
    NULL AS PLATFORM,
    COMPETITOR AS PRIMARY_COMPETITOR,
    NULL AS PRIMARY_QUOTE_ID,
    PRIMARY_PRODUCT_OF_INTEREST AS PRODUCTS_OF_INTEREST,
    PROBABILITY,
    NULL AS RAMPED_ACV,
    REGION_NAME AS REGION,
    NULL AS RENEWED_AMOUNT,
    CASE
        WHEN TYPE = 'Renewal'
            THEN ARR
        ELSE 0 END RENEWAL_DOLLARS,
    (CURRENT_AVG_MRR_TOTAL * 12) AS RENEWAL_DUE,
    DATEADD(DD,-1,MRR_SUB_START) AS RENEWAL_DUE_DATE,
    ((CURRENT_AVG_MRR_TOTAL + CS_FORECAST_MRR) * 12) AS RENEWAL_FORECAST_ARR,
    NULL AS RENEWAL_UPLIFT,
    SALES_ENGINEER_NAME,
    SALES_MRR,
    SALES_ACCEPTED AS SALES_OPPORTUNITY_ACCEPTED,
    NULL AS SALES_OPPORTUNITY_ACCEPTED_DATE,
    SALESFORCE_ORG__C AS SALESFORCE_ORG,
    SE_ASSIGNED__C AS SE_ID,
    SEGMENT,
    STAGENAME AS STAGE,
    NULL AS STAGE_1_DATE_OF_ENTRY,
    MRR_SUB_START AS START_DATE,
    SUBTYPE AS SUB_TYPE,
    TCV_NON_RECURRING::NUMBER(19,2) AS TCV_NON_RECURRING,
    TCV_SERVCES::NUMBER(19,2) AS TCV_SERVICES,
    TCV_SUBSCRIPTIONS::NUMBER(19,2) AS TCV_SUBSCRIPTIONS,
    DATEDIFF(month, MRR_SUB_END, MRR_SUB_START) AS TERM_MONTHS,
    SEGMENT_TERRITORY_NAME AS TERRITORY,
    TM_TERRITORY_MANAGERID__C as TERRITORY_MANAGER_ID,
    TERRITORY_MANAGER_NAME,
    TM_SEGMENT_NAME,
    NULL AS TOTAL_DEAL_VALUE,
    NULL AS TOTAL_RENEWAL_DUE,
    NULL AS TOTAL_UPSELL_DOWNSELL,
    TYPE,
    NULL AS VALID_UNTIL_DATE,
    X15_DATE__C AS X15_DATE,
    APTTUS_OPPTY_ID AS XOPPORTUNITY_ID,
	OPPTY_MODSTAMP,
	ACCNT_MODSTAMP,
	GREATEST(OPPTY_MODSTAMP,ACCNT_MODSTAMP) AS LAST_MODSTAMP    
FROM APTTUS_DW.SF_CONGA1_0."Opportunity_C1"     
UNION
SELECT 'Apttus1.0' AS CRM_SOURCE,
    PARTNER_SOURCE__C AS A1_PARTNER,
    ACCOUNTID AS ACCOUNT_ID,
    ACCOUNT_NAME,
    ACCOUNT_OWNER_NAME,
    ACCOUNTURL AS ACCOUNT_URL,
    ANNUAL_RENEWAL,
    FIRST_YEARS_BILLINGS::NUMBER(19,2) AS ARR,
    AGE_OF_THE_DEAL_DAYS AS AGE_DAYS,
    AGE_OF_THE_DEAL_MONTHS AS AGE_MONTHS,
    NULL AS AVERAGE_ACV,
    NULL AS BILLING_FREQUENCY,
    CLOSEDATE AS BOOKINGS_DATE,
    'Apttus' AS BOOKING_STAMP,
    NULL AS C1_PARTNER,
    PREDICTED_C2_STAGE AS C2_STAGE,
    PREDICTED_C2_TYPE AS C2_TYPE,
    CAMPAIGNID AS CAMPAIGN_ID,
    CLOSEDATE AS CLOSE_BOOKINGS_DATE,
    COALESCE(CLOSED_REASON_CATEGORY_LOSS, CLOSED_REASON_CATEGORY_WIN) AS CLOSED_REASON_CATEGORY,
    NULL AS CLOSED_REASON_DETAILS,
    NULL AS CLOSED_REASON_NOTES,
    CLOSED_REASON_SUBCATEGORY_LOSS,
    CONTACT__C AS CONTACT_ID,
    CREATEDDATE AS CREATED_DATE,
    CURRENCY,
    CURRENCY_CONVERSION_RATE,
    NULL AS CURRENT_AVG_MRR_TOTAL,
    NULL AS CUSTOMER_SUPPORT_ID,
    ACCOUNT_CUSTOMER_MANAGER_NAME AS CUSTOMER_SUPPORT_NAME,
    NULL AS DISCOUNT_RECAPTURE_MRR,
    DOWNSELL_CHURN_CATEGORY, 
    DOWNSELL_CHURN_SUB_CATEGORY,
    VALID_UNTIL_DATE__C AS END_DATE,
    CLOSEDATE AS ESTIMATED_CLOSE_DATE,
    EXPANSION_DOLLARS,
    FIRST_YEARS_BILLINGS::NUMBER(19,2) as FIRST_YEARS_BILLINGS,
    FISCAL_WEEK,
    FORECAST_CATEGORY,
    GEO,
    HIGHEST_ACHIEVED_STAGE,
    INBOUND_OUTBOUND_OPPORTUNITY__C AS INBOUND_OUTBOUND_OPPORTUNITY,
    LAST_EDIT_DATE,
    LEAD_SOURCE,
    NULL AS LEAD_SOURCE_DETAIL,
    NULL AS MRR_SUB_END,
    NULL AS MRR_SUB_START,
    NULL AS NET_NEW_MRR,
    NEXTSTEP AS NEXT_STEP,
    NEXT_STEP_LAST_EDITED__C AS NEXT_STEP_LAST_EDITED,
    NULL AS NN_DISCOUNT_RECAPTURE_ACV,
    OPPORTUNITY_SOURCE AS OPPORTUNITY_CHANNEL_SOURCE,
    OPPORTUNITY_ID,
    OPPORTUNITY_NAME,
    OPPORTUNITYURL AS OPPORTUNITY_URL,
    TRUE AS OPS_APPROVED,
    GEO AS OWNER_GEO_STAMP,
    OWNERID AS OWNER_ID,
    OWNER_NAME,
    OWNER_ROLE,
    PLATFORM,
    PRIMARY_COMPETITOR,
    PRIMARY_QUOTE_ID,
    PRODUCTS_OF_INTEREST__C AS PRODUCTS_OF_INTEREST,
    PROBABILITY,
    RAMPED_ACV__C::NUMBER(19,2) AS RAMPED_ACV,
    REGION AS REGION,
    RENEWED_AMOUNT,
    RENEWAL_DOLLARS,
    RENEWAL_DUE,
    RENEWAL_DUE_DATE,
    (RENEWAL_DOLLARS + RENEWAL_UPLIFT) AS RENEWAL_FORECAST_ARR,
    RENEWAL_UPLIFT,
    SALES_ENGINEER AS SALES_ENGINEER_NAME,
    NULL AS SALES_MRR,
    OPPORTUNITY_ACCEPTED__C AS SALES_OPPORTUNITY_ACCEPTED,
    OPPORTUNITY_ACCEPTED_DATE__C AS SALES_OPPORTUNITY_ACCEPTED_DATE,
    NULL AS SALESFORCE_ORG,
    APTTUS_SE__C AS SE_ID,
    SEGMENT__C AS SEGMENT,
    STAGENAME AS STAGE,
    STAGE_1_DATE_OF_ENTRY__C AS STAGE_1_DATE_OF_ENTRY,
    SUBSCRIPTION_START_DATE AS START_DATE,
    SUBTYPE AS SUB_TYPE,
    NULL AS TCV_NON_RECURRING,
    NULL AS TCV_SERVICES,
    NULL AS TCV_SUBSCRIPTIONS,
    TERM_MONTHS,
    TERRITORY_NAME AS TERRITORY,
    OWNERID AS TERRITORY_MANAGER_ID,
    OWNER_NAME AS TERRITORY_MANAGER_NAME,
    NULL AS TM_SEGMENT_NAME,
    TOTAL_DEAL_VALUE::NUMBER(19,2) AS TOTAL_DEAL_VALUE,
    TOTAL_RENEWAL_DUE__C::NUMBER(19,2) AS TOTAL_RENEWAL_DUE,
    TOTAL_UPSELL_DOWNSELL,
    TYPE,
    VALID_UNTIL_DATE__C AS VALID_UNTIL_DATE,
    NULL AS X15_DATE,
    CONGA1_OPPTY_ID AS XOPPORTUNITY_ID,
	OPPTY_MODSTAMP,
	ACCNT_MODSTAMP,
	GREATEST(OPPTY_MODSTAMP,ACCNT_MODSTAMP) AS LAST_MODSTAMP    
FROM APTTUS_DW.SF_PRODUCTION."Opportunity_A1"
WHERE TYPE <> 'Services'
  AND IGNORE_TESTOPPORTUNITIES = 1;